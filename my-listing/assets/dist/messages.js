!function(t){"function"==typeof define&&define.amd?define("messages",t):t()}(function(){"use strict";function i(t){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){for(var s=0;s<e.length;s++){var n=e[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var e,t=function(){function s(t){for(var e in function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),this.data=t)this[e]=t[e];this.$=jQuery,this.post=this.$.post,this.syncStatus=!0,this.startTime=0,this.endTime=0,this.moreMessages=0,this.inboxMessages=0,this.inboxMsgRemaining=0,this.userPage=1,this.inboxPage=1,this.syncDelay=3e3,this.settings=ml_msg,this.deletedGroups=[],this.loading=!1,this.postData=[],this._blocked=!1,this._loaded={},this._endReached=[],this._queList={},this._activitiesCount={},this._opponents={},ml_msg.pod&&(this._opponents[ml_msg.pod.id]=ml_msg.pod),jQuery(document).ready(this.sync.bind(this))}return function(t,e,s){e&&n(t.prototype,e),s&&n(t,s)}(s,[{key:"sync",value:function(){var s=this,n=this.startTime,t=this.post(CASE27.mylisting_ajax_url,{action:"mylisting_sync_messages",st:this.startTime,et:this.endTime,uc:Object.keys(this._opponents).length,up:this.startTime?this.userPage:this.inboxPage,dg:this.deletedGroups,opponent_id:this.opponentId,pid:this.postData.id||0,async:!0,cache:!1,no_idle:1}).done(function(t){if(!t.success||!t.data.hasOwnProperty("ml")||!t.data.hasOwnProperty("st")||!t.data.hasOwnProperty("et")||t.data.st.length<10)return!1;if(n||(s.inboxMessages=s.inboxMsgRemaining<parseInt(t.data.fr),s.inboxMsgRemaining=s.inboxMsgRemaining+Object.keys(t.data.ml).length),10<=t.data.st.toString().length){s.startTime=t.data.st,s.endTime=t.data.et;var e=parseInt(t.data.fr)-Object.keys(t.data.ml).length;s.moreMessages=0<e?e:0}s.$.isEmptyObject(t.data.ml)||s._addMessages(t.data.ml)}).complete(function(){if(s.isLoading=!1,!s.syncStatus)return!1;setTimeout(function(){if(void 0!==t._rejected&&t._rejected)return!1;s.sync()},s.syncDelay)});e=t}},{key:"resetSync",value:function(t){this.startTime=0,this.endTime=0,this.cancelSync(),"function"==typeof t&&t(),this.sync()}},{key:"cancelSync",value:function(){e._rejected=!0,e.abort()}},{key:"deleteGroup",value:function(s){if("object"===i(this.messages[s.op.id])){var n=[];this.messages[s.op.id].forEach(function(t,e){if(t.pid===s.pid)return null;n.push(t)}),this.messages[s.op.id]=n}return this.post(CASE27.mylisting_ajax_url,{action:"mylisting_delete_conversation",seckey:s.dcn,pid:s.pid,opponent_id:s.op.id})}},{key:"loadMore",value:function(t,e){var s=this,n=this.postData.id||0,i=this.opponentId+"-"+n;if(!this.opponentId||-1!==this._endReached.indexOf(i))return null;(t=void 0===t)&&this._decreaseActivities(this._activitiesCount[i]),this.loading=!0,this.post(CASE27.mylisting_ajax_url,{action:"mylisting_read_conversation",opponent_id:this.opponentId,pid:n,mark_all_read:t,offset:this.groupMessages(this.opponentId,n).length}).done(function(t){return s.loading=!1,s.$.isEmptyObject(t.data.ml)?(s._endReached.push(i),"function"==typeof e?e(!0):null):(s._addMessages(t.data.ml),"function"==typeof e?e():null)})}},{key:"send",value:function(t,e){var s=this;this.$.isEmptyObject(e)&&(e=this.postData);var n=this.postData.id||0,i=this._addToQuelist({opid:this.opponentId,pid:n,message:t,postData:e});return this.post(CASE27.mylisting_ajax_url,{action:"mylisting_send_message",receiver_id:this.opponentId,seckey:this.settings.smn,pid:n,message:t}).done(function(t){if(t&&void 0!==t.success&&!t.success){new MyListing.Dialog({message:t.data,timeout:3e3,dismissable:!0}),s._blocked="long",setTimeout(function(){s._blocked=!1},3e3),s.messages[s.opponentId][i].loading="error"}})}},{key:"deleteMsg",value:function(t){var e=this;for(var s in this.messages[t.op.id])if(t.id===this.messages[t.op.id][s].id){delete this.messages[t.op.id][s];break}return this.messages[t.op.id]=this.messages[t.op.id].filter(function(){return!0}),this.messages=Object.assign({},this.messages),this.post(CASE27.mylisting_ajax_url,{action:"mylisting_delete_message",message_id:t.id,seckey:t.dm}).complete(function(){e.scrollToEnd=!0})}},{key:"setOpponent",value:function(t,e){this.setPostData(e),this.opponentId=t,this.scrollToEnd=!0,this.messages[t]=this.messages[t]||[],this._loaded[t]=this._loaded[t]||[];var s=this.postData.id||0;this.conversation=this.groupMessages(t,s)}},{key:"getOpponent",value:function(t){return void 0!==this._opponents[t]&&this._opponents[t]}},{key:"cacheOpponents",value:function(t){for(var e in t)this._opponents[e]=t[e]}},{key:"groupMessages",value:function(t,e){if("object"!==i(this.messages[this.opponentId]))return[];var s=[];return this.messages[this.opponentId].forEach(function(t){if(parseInt(t.pid)!==e)return null;s.push(t)}),s}},{key:"setPostData",value:function(t){if("object"!==i(t))return!1;this.postData=t}},{key:"loadUser",value:function(e,s){var n=this;if(void 0!==this._opponents[e])return s(this._opponents[e]);this.post(CASE27.mylisting_ajax_url,{action:"mylisting_recipients",user_id:e}).done(function(t){return t.success&&t.data[e]?(n.cacheOpponents(t.data),s(n._opponents[e])):s(!1)})}},{key:"toggleBlockStatus",value:function(n,i){var o=this;this.post(CASE27.mylisting_ajax_url,{action:"mylisting_block_sender",opponent_id:n.id,seckey:n.seckey}).done(function(t){if(!t)return!1;if(o._opponents[n.id].blocked=t.data.state,"function"!=typeof i)return null;var e=o.messages[n.id];for(var s in e)e[s].op.blocked=t.data.state;o.messages=Object.assign({},o.messages),i(o._opponents[n.id])})}},{key:"_addToQuelist",value:function(t){var e=t.opid||this.opponentId,s=this.getOpponent(e);return s?(void 0===this.messages[e]&&(this.messages[e]=[],this._loaded[e]=[]),void 0===this._queList[e]&&(this._queList[e]=0),this._queList[e]=this._queList[e]+1,this.messages[e].push({id:"_temp_message",message:t.message,op:s,sender:ml_msg.cu.id,utime:moment().unix(),loading:!0,seen:1,pid:t.pid,pdata:t.postData}),this.messages=Object.assign({},this.messages),0<this.messages[e].length?this.messages[e].length-1:0):0}},{key:"_decreaseActivities",value:function(t){var s=this;this.activities=this.activities-t,this.activities<0&&(this.activities=0);var n=this.postData.id||0;this.$.each(this.messages[this.opponentId],function(t,e){if(parseInt(e.pid)!==n)return null;s.messages[s.opponentId][t].seen=1})}},{key:"_clearQueList",value:function(t){if(void 0===this._queList[t]||this._queList<=0||void 0===this.messages[t])return null;var e=[];for(var s in this.messages[t]){var n=this.messages[t][s];"_temp_message"!==n.id&&e.push(n)}this.messages[t]=e}},{key:"_addMessages",value:function(t){var i=this,o=[];this.$.each(t,function(t,e){var s=e.op.id;-1===o.indexOf(s)&&o.push(s),i._opponents[s]=e.op;var n=s+"-"+e.pid;if(void 0===i.messages[s]&&(i.messages[s]=[],i._loaded[s]=[],i._activitiesCount[n]=0),-1!==i._loaded[s].indexOf(t))return null;parseInt(e.seen)||e.op.id===i.opponentId||0!==parseInt(e.seen)||parseInt(e.sender)===parseInt(ml_msg.cu.id)?e.seen=1:(i.activities=i.activities+1,i._activitiesCount[n]=i._activitiesCount[n]+1),i._clearQueList(s),i.messages[s].push(e),i._loaded[s].push(t)}),o.forEach(function(t){i.messages[t]=i.messages[t].sort(function(t,e){return t.utime>e.utime?1:-1})}),this.messages=Object.assign({},this.messages)}}]),s}(),s={props:["chat"],template:"#ml-inbox",data:function(){return{loading:!1}},computed:{loadMoreBtn:function(){return this.chat.inboxMessages},isMessages:function(){for(var t in this.loading=!1,this.chat.messages)if(this.chat.messages[t].length)return!0;return!1},isLoading:function(){return this.chat.isLoading}},methods:{compose:function(){this.chat.mode="compose"},loadMore:function(){var t=this;this.loading=!0,this.chat.resetSync(function(){t.chat.inboxPage++})}},components:{messages:{props:["chat","isLoading"],data:function(){return{deleteConfirm:null,blockConfirm:null,blockRequest:!1}},computed:{messageList:function(){var t=[];for(var e in this.chat.messages)if(Object.keys(this.chat.messages[e]).length){var s={};for(var n in this.chat.messages[e]){var i=this.chat.messages[e][n];void 0===s[i.pid]&&(s[i.pid]=[]),s[i.pid].push(i)}for(var o in s){var a=s[o][Object.keys(s[o]).length-1],r=0<parseInt(a.seen)||parseInt(a.sender)===parseInt(ml_msg.cu.id);t.push({opid:e,data:a,seen:r})}}return t.sort(function(t,e){var s=parseInt(t.data.seen),n=parseInt(e.data.seen);return s===n||parseInt(t.data.sender)===parseInt(ml_msg.cu.id)||parseInt(e.data.sender)===parseInt(ml_msg.cu.id)?t.data.utime<e.data.utime?1:-1:n<s?1:-1})}},methods:{timestamp:function(t){return moment.unix(t).fromNow()},deleteConversation:function(t){var e=t.op.id+"-"+t.pid;if(this.deleteConfirm!==e)return this.deleteConfirm=e;this.chat.deleteGroup(t),this.deleteConfirm=null},isDelete:function(t){return t.data.op.id+"-"+t.data.pid===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null},open:function(t){if(this.deleteConfirm||this.blockConfirm)return null;this.chat.setOpponent(t.op.id,t.pdata),this.chat.loadMore(),this.chat.mode="conversation"},opponentInfo:function(t){return t.op.name},isPost:function(t){return t.pdata.id},isPostAuthor:function(t){return parseInt(t.op.id)===t.pdata.author},blockUser:function(t,e){var s=this;if(this.blockConfirm!==parseInt(t.op.id))return this.blockConfirm=parseInt(t.op.id);this.blockRequest=t.op.id,this.chat.toggleBlockStatus(t.op,function(t){s.blockRequest=!1}),this.blockConfirm=null},beingBlocked:function(t){return this.blockRequest&&this.blockRequest===parseInt(t.opid)},isBlocking:function(t){return parseInt(t.opid)===this.blockConfirm},isBlocked:function(t){return this.chat._opponents[t.data.op.id].blocked},cancelBlock:function(){this.blockConfirm=null}},template:"#ml-inbox-messages"}}},o={props:["chat","conversation"],template:"#ml-conversation",data:function(){return this._initialState()},created:function(){this.initialize()},watch:{message:function(){var t=this.message.match(/\n/g),e=t?t.length:1;if(5<e)return null;this.rows=e},"chat.opponentId":function(){this.initialize()}},computed:{isLoading:function(){return this.chat.loading},disable:function(){var t=!!this.chat._blocked||this.opponent.blocked;return!1===t&&setTimeout(function(){jQuery("#ml-conv-textarea").focus()},100),t},disableMessage:function(){return!this.opponent}},methods:{initialize:function(){var e=this;this.endTime(),Object.assign(this.$data,this._initialState()),this.chat.loadUser(this.chat.opponentId,function(t){if(!t)return new MyListing.Dialog({message:ml_msg.strings.notAvailable}),e.inbox();e.opponent=e.chat._opponents[e.chat.opponentId],e.init=!1,e.startTime(),e.$root.mobile.matches||e.$nextTick(function(){jQuery(e.$el).find("#ml-conv-textarea").focus()})})},inbox:function(){this.chat.opponentId=0,this.chat.mode="inbox"},send:function(t){if(t&&t.shiftKey)return!0;if(this.message=jQuery.trim(this.message),!this.message.length||this.chat._blocked)return null;this.disableSend(),this.$root.chat.scrollToEnd=!0;var e=this.conversation[0]||!1,s={};e&&(s=Object.assign({},e.pdata)),this.chat.send(this.message,s),this.message=""},goToInbox:function(){this.chat.opponentId=0,this.chat.mode="inbox"},disableSend:function(){var t=this;this.chat._blocked="short",setTimeout(function(){"short"===t.chat._blocked&&(t.chat._blocked=!1)},ml_msg.sd)},isPostAuthor:function(){if(!this.conversation.length)return this.chat.postData.id||!1;var t=this.conversation[0];return parseInt(t.op.id)===parseInt(t.pdata.author)},deleteConversation:function(){if(!this.conversation.length)return this.goToInbox();var t=this.conversation[0],e=t.op.id+"-"+t.pid;if(this.deleteConfirm!==e)return this.deleteConfirm=e;this.chat.deleteGroup(t),this.deleteConfirm=null,this.goToInbox()},isDelete:function(){var t=this.conversation[0]||!1;return!!t&&t.op.id+"-"+t.pid===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null},startTime:function(){this._interval=setInterval(this.updateTime.bind(this),4e4)},endTime:function(){clearInterval(this._interval)},updateTime:function(){this.messages=Object.assign([],this.conversation)},blockUser:function(){var e=this;if(this.blockConfirm!==parseInt(this.opponent.id))return this.blockConfirm=parseInt(this.opponent.id);this.blockRequest=!0,this.chat.toggleBlockStatus(this.opponent,function(t){e.opponent=t,e.blockRequest=!1}),this.blockConfirm=null},isBlockUser:function(){return parseInt(this.opponent.id)===this.blockConfirm},isBlocked:function(){return this.chat._opponents[this.opponent.id].blocked},cancelBlock:function(){this.blockConfirm=null},_initialState:function(){return{init:!0,opponent:{},messages:{},message:"",deleteConfirm:null,blockConfirm:null,blockRequest:!1,maxLength:ml_msg.mcl,rows:1,_sd:ml_msg.sd}}},components:{messages:{props:["conversation","opponent","chat"],data:function(){return{deleteConfirm:null,_interval:null}},watch:{conversation:function(){this.scrollWindow()}},mounted:function(){this.bindScroll(),this.scrollWindow()},computed:{messages:function(){return this.conversation},isMessages:function(){return Object.keys(this.conversation).length},isLoading:function(){return this.chat.loading}},methods:{conversationClass:function(t){return parseInt(t.sender,10)===parseInt(ml_msg.cu.id,10)?"responder-2":"responder-1"},userLink:function(t){return t.sender_uri},loadingClass:function(t){return"boolean"==typeof t.loading?"fa fa-refresh":"mi error_outline"},timestamp:function(t){return moment.unix(t).fromNow()},deleteMsg:function(t){if(this.deleteConfirm!==parseInt(t.id))return this.unbindScroll(),this.deleteConfirm=parseInt(t.id);this.$root.chat.deleteMsg(t),this.bindScroll()},isDelete:function(t){return parseInt(t.id)===this.deleteConfirm},cancelDelete:function(){this.deleteConfirm=null,this.bindScroll()},isPost:function(t){return t.pdata.id},isPostAuthor:function(t){return parseInt(t.sender)===t.pdata.author},isOpponent:function(t){return parseInt(t.sender)===parseInt(t.op.id)},senderAvatar:function(t){return parseInt(t.sender)===parseInt(t.op.id)?t.op.avatar:ml_msg.cu.avatar},scrollListener:function(t){var e=this;if(50<t.target.scrollTop)return null;this.$root.chat.scrollToEnd=!1,this.unbindScroll(),this.$root.chat.loadMore(!0,function(t){e.$el.scrollTop<55&&(e.$el.scrollTop=55),e.bindScroll()})},bindScroll:function(){this.$el.addEventListener("scroll",this.scrollListener)},unbindScroll:function(){this.$el.removeEventListener("scroll",this.scrollListener)},scrollWindow:function(){if(!this.$root.chat.scrollToEnd||this.deleteConfirm)return null;this.$el.scrollTop=this.$el.scrollHeight},linkify:function(t){var e,s,n,i=t.message;return"_temp_message"===t.id?i:(e=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,s=/(^|[^\/])(www\.[\S]+(\b|$))/gim,n=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,i.replace(e,'<a href="$1" target="_blank" rel="nofollow">$1</a>').replace(s,'$1<a href="http://$2" target="_blank" rel="nofollow">$2</a>').replace(n,'<a href="mailto:$1">$1</a>'))}},updated:function(){this.scrollWindow()},template:"#ml-conversation-messages"}},beforeDestroy:function(){this.endTime()}},a={props:["chat"],template:"#ml-compose-message",data:function(){return{opponentId:0,message:"",selected:2,url:CASE27.mylisting_ajax_url,options:null}},computed:{opponentName:function(){return this.chat.getOpponent(this.opponentId).name}},watch:{opponentId:function(t){this.chat.setOpponent(this.opponentId),this.chat.mode="conversation",this.chat.loadMore(),this.message=""}},methods:{inbox:function(){this.chat.mode="inbox"}},components:{select2:{props:["chat","options","value","url"],template:"#ml-opponent-list",data:function(){var s=this,e=this;return{term:null,ajaxOptions:{url:this.url,type:"POST",dataType:"json",delay:250,data:function(t){return e.term=t.term,{action:"mylisting_recipients",term:t.term,page:t.page}},processResults:function(t,e){return t.success&&s.chat.cacheOpponents(t.data),e.page=e.page||1,{results:s.opponents,pagination:{more:30*e.page<[].total_count}}},cache:!0}}},computed:{opponents:function(){var t=[],e=void 0!==this.term?this.term.toLowerCase():"";for(var s in this.chat._opponents){var n=this.chat._opponents[s];!n.login||e&&e!==n.name.toLowerCase().substr(0,e.length)||t.push({id:s,text:this.chat._opponents[s].name})}return t}},mounted:function(){var e=this;this.chat.postData={},this.el=jQuery(this.$el).select2({data:this.options,placeholder:ml_msg.strings.selectUser,ajax:this.ajaxOptions,language:{errorLoading:function(){return CASE27.l10n.errorLoading},loadingMore:function(){return CASE27.l10n.loadingMore},noResults:function(){return CASE27.l10n.noResults},searching:function(t){return MyListing.Select_Config.lastSearch=t,CASE27.l10n.searching}}}).on("change",function(t){e.$parent.opponentId=t.currentTarget.value,e.$emit("input",t.currentTarget.value)})},destroyed:function(){this.el.off().select2("destroy")}}}};window.MyListing.Messages=new Vue({el:"#ml-message-btn",data:{modal:jQuery("#ml-messages-modal"),modal_open:!1,mobile:window.matchMedia("screen and (max-width: 790px)"),chat:new t({mode:!1,messages:{},conversation:[],pending:{},activities:0,opponentId:0,compose:!1,scrollToEnd:!0,allRead:!1,isLoading:!0,_lastMode:"inbox",_directOpen:!1})},created:function(){var t=this;this.mobile.matches&&(jQuery("#ml-messages-modal").on("shown.bs.modal",function(){jQuery("html, body").addClass("disable-scroll")}),jQuery("#ml-messages-modal").on("hidden.bs.modal",function(){jQuery("html, body").removeClass("disable-scroll")})),jQuery("#ml-messages-modal").on("shown.bs.modal",function(){t.modal_open=!0}),jQuery("#ml-messages-modal").on("hidden.bs.modal",function(){t._directOpen&&(t.chat.opponentId=0,t.chat.mode="inbox",t._directOpen=!1),t.modal_open=!1})},mounted:function(){this.$el.addEventListener("touchmove",MyListing.Helpers.debounce(function(){document.body.scrollTop=0},50))},watch:{"chat.activities":function(t){var e=jQuery("#ml-chat-activities");if(t=parseInt(t),isNaN(t)||t<=0)return e.html("<span>0</span>").hide();9<t&&(t=ml_msg.strings.nineplus),e.html("<span>"+t+"</span>").show()},"chat.messages":function(t){if(!this.chat.opponentId)return[];var e=this.chat.postData.id||0;this.chat.conversation=this.chat.groupMessages(this.chat.opponentId,e)},"chat.opponentId":function(t){if(parseInt(t))return this.chat.mode="conversation",t;this.chat.mode="inbox",this.chat.conversation=[]}},methods:{toggle:function(){var t=this.chat._lastMode,e=this.chat.mode;this.chat._lastMode=e,this.chat.mode=t},close:function(){this.modal.modal("hide")},open:function(t,e){this._directOpen=!0,this.chat.setPostData(e),this.chat.setOpponent(t),this.chat.loadMore(),this.modal.modal("show")}},components:{inbox:s,conversation:o,compose:a}})});
